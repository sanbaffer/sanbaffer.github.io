<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AR Снеговик — фонтан</title>
  <style>
    html,body{height:100%;margin:0;background:#000}
    #ui{position:fixed;left:10px;top:10px;z-index:999;color:#fff;font-family:sans-serif}
    .panel{background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;margin-bottom:8px}
    label{display:block;margin-top:6px;font-size:13px}
    input[type=range]{width:200px}
    button{margin-top:6px;padding:6px 10px;border-radius:6px;border:0;background:#1e90ff;color:#fff}
    #message{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0009;color:#fff;padding:8px 12px;border-radius:8px}
    #placeHint{position:fixed;right:10px;top:10px;background:#0009;color:#fff;padding:8px;border-radius:8px}
  </style>
  <!-- THREE.js + examples (module) -->
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
    import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/webxr/ARButton.js';
    import { ObjectLoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/src/loaders/ObjectLoader.js';
    import { CatmullRomCurve3 } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/src/extras/curves/CatmullRomCurve3.js';

    let camera, scene, renderer;
    let controller;
    let reticle = null;
    let snowman = null;
    let anchor = null; // reference point in world
    let animationMixer = null;
    let clock = new THREE.Clock();
    let path = null; // CatmullRomCurve3
    let waypoints = []; // local positions relative to anchor
    let loopAnimation = true;
    let progress = 0; // 0..1 along path
    let speed = 0.02; // adjustable
    let mediaRecorder = null;
    let recordedChunks = [];

    const params = {
      scale: 1,
      speed: 0.02,
      autoplay: true
    };

    init();

    function init(){
      const container = document.createElement('div');
      document.body.appendChild(container);

      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera();

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      renderer.xr.setReferenceSpaceType('local');
      container.appendChild(renderer.domElement);

      document.body.insertAdjacentHTML('beforeend', `
        <div id="ui">
          <div class="panel">
            <strong>AR Снеговик — управление</strong>
            <label>Масштаб: <input id="scale" type="range" min="0.2" max="4" step="0.05" value="1"></label>
            <label>Скорость: <input id="speed" type="range" min="0.005" max="0.2" step="0.005" value="0.02"></label>
            <button id="startStop">Start/Stop движение</button>
            <button id="resetPath">Сбросить путь</button>
            <button id="addWaypoint">Добавить точку (установить возле контейнера)</button>
            <button id="takePhoto">Сделать фото</button>
            <button id="startRec">Начать запись</button>
            <button id="stopRec">Остановить запись</button>
            <div style="margin-top:6px">
              Модель: <input id="file" type="file" accept=".glb,.gltf,.json">
            </div>
          </div>
        </div>
      `);

      const placeHint = document.createElement('div');
      placeHint.id = 'placeHint';
      placeHint.innerText = 'Наведите камеру на фонтан и коснитесь экрана для установки снеговика';
      document.body.appendChild(placeHint);

      // AR Button
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // light
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      scene.add(light);

      // reticle for placement
      reticle = new THREE.Mesh(
        new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI/2),
        new THREE.MeshBasicMaterial({ color: 0x0fff0, side: THREE.DoubleSide })
      );
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      // controller for select
      controller = renderer.xr.getController(0);
      controller.addEventListener('select', onSelect);
      scene.add(controller);

      // UI events
      document.getElementById('scale').addEventListener('input', (e)=>{ params.scale = parseFloat(e.target.value); if(snowman) snowman.scale.setScalar(params.scale); });
      document.getElementById('speed').addEventListener('input', (e)=>{ params.speed = parseFloat(e.target.value); });
      document.getElementById('startStop').addEventListener('click', ()=>{ params.autoplay = !params.autoplay });
      document.getElementById('resetPath').addEventListener('click', ()=>{ waypoints = []; path = null; progress = 0; showMessage('Путь сброшен'); });
      document.getElementById('addWaypoint').addEventListener('click', addWaypointAtReticle);
      document.getElementById('file').addEventListener('change', onFile);
      document.getElementById('takePhoto').addEventListener('click', takePhoto);
      document.getElementById('startRec').addEventListener('click', startRecording);
      document.getElementById('stopRec').addEventListener('click', stopRecording);

      window.addEventListener('resize', onWindowResize);

      // WebXR hit test setup
      const sessionInit = { optionalFeatures: ['dom-overlay'], domOverlay: { root: document.body } };
      renderer.xr.addEventListener('sessionstart', async ()=>{
        const session = renderer.xr.getSession();
        const viewerSpace = await session.requestReferenceSpace('viewer');
        session.requestHitTestSource({ space: viewerSpace }).then((source)=>{
          renderer.xr.getSession().hitTestSource = source;
        }).catch(()=>{});
      });

      renderer.setAnimationLoop(render);

      showMessage('Загрузка готова. Откройте AR (кнопка AR справа) и наведите камеру на фонтан.');

      // Auto-place if URL param present
      const urlParams = new URLSearchParams(window.location.search);
      if(urlParams.get('autoplace') === '1') showMessage('Сканирован QR: готов к установке.');
    }

    function onWindowResize(){
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    async function onSelect(){
      // place model at reticle position
      if(!reticle.visible){ showMessage('Сначала наведите камеру на поверхность (фонтан)'); return; }

      if(!snowman){
        showMessage('Модель не загружена. Загрузите .glb/.json в UI вверху.');
        return;
      }

      // create anchor group
      anchor = new THREE.Group();
      anchor.position.setFromMatrixPosition(reticle.matrix);
      anchor.quaternion.setFromRotationMatrix(reticle.matrix);
      scene.add(anchor);

      // move model under anchor
      anchor.add(snowman);
      snowman.position.set(0, 0, 0);
      snowman.rotation.set(0,0,0);
      snowman.scale.setScalar(params.scale);

      showMessage('Снеговик размещён. Добавьте точки пути или начните анимацию.');
    }

    function showMessage(text, time=3000){
      let el = document.getElementById('message');
      if(!el){ el = document.createElement('div'); el.id='message'; document.body.appendChild(el); }
      el.textContent = text;
      el.style.opacity = '1';
      setTimeout(()=>{ el.style.opacity = '0'; }, time);
    }

    function addWaypointAtReticle(){
      if(!reticle.visible){ showMessage('Наведи камеру на поверхность и дождись появления метки.'); return; }
      if(!anchor){ showMessage('Сначала коснитесь экрана, чтобы разместить снеговика (или дождитесь автопомещения по QR).'); return; }
      // compute reticle position in anchor local space
      const worldPos = new THREE.Vector3().setFromMatrixPosition(reticle.matrix);
      const localPos = worldPos.clone().sub(anchor.position);
      waypoints.push(localPos);
      rebuildPath();
      showMessage('Точка добавлена: ' + waypoints.length);
    }

    function rebuildPath(){
      if(waypoints.length < 2){ path = null; return; }
      // ensure closed loop by repeating first point at end
      const pts = waypoints.map(p=>p.clone());
      pts.push(pts[0].clone());
      path = new CatmullRomCurve3(pts, true);
    }

    function onFile(e){
      const file = e.target.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      const name = file.name.toLowerCase();
      if(name.endsWith('.glb') || name.endsWith('.gltf')){
        const loader = new GLTFLoader();
        loader.load(url, (gltf)=>{
          if(snowman) snowman.parent && snowman.parent.remove(snowman);
          snowman = gltf.scene;
          showMessage('GLB загружен');
        }, undefined, (err)=>{ console.error(err); showMessage('Ошибка загрузки GLB'); });
      } else if(name.endsWith('.json')){
        const loader = new ObjectLoader();
        loader.load(url, (obj)=>{ if(snowman) snowman.parent && snowman.parent.remove(snowman); snowman = obj; showMessage('JSON модель загружена'); }, undefined, (err)=>{ console.error(err); showMessage('Ошибка ObjectLoader'); });
      } else { showMessage('Тип файла не поддерживается'); }
    }

    function takePhoto(){
      // draw current frame to dataURL and open in new tab
      renderer.render(scene, camera); // ensure up-to-date
      try{
        const data = renderer.domElement.toDataURL('image/png');
        const a = document.createElement('a'); a.href = data; a.download = 'snowman_ar.png'; document.body.appendChild(a); a.click(); a.remove();
      } catch(err){ console.error(err); showMessage('Ошибка создания фото'); }
    }

    function startRecording(){
      if(mediaRecorder) { showMessage('Уже записывается'); return; }
      const stream = renderer.domElement.captureStream(30);
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
      recordedChunks = [];
      mediaRecorder.ondataavailable = function(e){ if(e.data.size>0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = ()=>{
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'snowman_ar.webm'; document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        mediaRecorder = null;
      };
      mediaRecorder.start();
      showMessage('Запись начата');
    }

    function stopRecording(){ if(mediaRecorder) mediaRecorder.stop(); else showMessage('Нет активной записи'); }

    // Render loop
    function render(timestamp, frame){
      const dt = clock.getDelta();

      // hit-test: update reticle
      if(renderer.xr.isPresenting && frame){
        const session = renderer.xr.getSession();
        const xrViewerPose = frame.getViewerPose(renderer.xr.getReferenceSpace());
        const hitTestSource = session.hitTestSource;
        if(hitTestSource){
          const hitTestResults = frame.getHitTestResults(hitTestSource);
          if(hitTestResults.length > 0){
            const hit = hitTestResults[0];
            const pose = hit.getPose(renderer.xr.getReferenceSpace());
            reticle.visible = true;
            reticle.matrix.fromArray(pose.transform.matrix);
          } else {
            reticle.visible = false;
          }
        }
      }

      // animate along path
      if(path && snowman && anchor && params.autoplay){
        progress += params.speed * dt * 60; // scale by framerate
        progress = progress % 1;
        const pos = path.getPointAt(progress);
        const tangent = path.getTangentAt(progress);
        snowman.position.copy(pos);
        // rotate to face tangent
        const angle = Math.atan2(tangent.x, tangent.z);
        snowman.rotation.y = angle;
      }

      // update mixer if animations present
      if(animationMixer) animationMixer.update(dt);

      renderer.render(scene, camera);
    }

  </script>
</head>
<body>
  <!--
    Инструкции:
    1) Разверните этот файл на HTTPS хостинге (Netlify/Vercel/GitHub Pages).
    2) Откройте страницу на мобильном устройстве с поддержкой WebXR (Chrome Android), нажмите AR.
    3) Разрешите доступ к камере, наведите на фонтан, коснитесь экрана для размещения снеговика.
    4) Добавляйте точки пути (Add waypoint) — снеговик будет двигаться по контуру. Используйте масштаб и скорость.
    5) Для QR: сгенерируйте QR, который ведёт на URL этой страницы. При открытии пользователь увидит инструкцию.

    Примечание: WebXR Hit Test необходим (Chrome Android). На iOS Safari WebXR поддержка ограничена — можно использовать модель-viewer + AR QuickLook вместо WebXR.
  -->
</body>
</html>
